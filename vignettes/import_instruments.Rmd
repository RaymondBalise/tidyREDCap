---
title: "Using the imports_instruments() function"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using the imports_instruments() function}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(tidyREDCap)
```


# The Problem 
If you have a REDCap project that has many instruments, some which are only used on an occasional visit the export from REDCap will be full of empty observations (because the instrument was not used on that visit).  It would be good to have a function that will export all the data from a project and produce one R table for each instrument. Those tables should remove the blank records.

### Aside: Loading REDCap Data into R
The `redcapAPI` package can be used to load data directly into R.  To learn more about it, take a look [here](https://github.com/nutterb/redcapAPI/wiki).  Normally the code to automatically pull data with an API includes a person's secret code "key".  Because I want to keep this hidden, I have hidden this API key in my user profile and the code below includes a call to `Sys.getenv()` to grab the key.  To learn more about working with APIs, look [here](https://daattali.gitbooks.io/stat545-ubc-github-io/bit003_api-key-env-var.html). Also notice that the data is saved using the `saveRDS()` function. REDCap data loaded with the API has the variable labels added as an extra attribute.  To allow this vignette to run without sharing my secret key, I have saved the data to the package website.

```{r getData, eval=FALSE}
rcon <- redcapAPI::redcapConnection(
  url = 'https://redcap.miami.edu/api/', 
  token = Sys.getenv("nacho_anxiety_key")
)

redcap <- redcapAPI::exportRecords(rcon)

saveRDS(redcap, file = "redcap.rds")
```

</br>
</br>

# The Solution

The `import_instruments()` function can be given the name of a redcapAPI connection, like the one created above and it will return one table for each instrument in a project.  By default the function will drop all records. For example the above api call is pulling data from a REDCap project that has four instruments: Enrollment, the Nacho Craving Index (NCI), the Generalised Anxiety Disorder Assessment (GAD7) and the Hamilton Anxiety Scale (HAM-A).

![](./dashboard.jpg)

```{r eval=FALSE}
import_instruments(rcon)
```

After running the above code I have four tables from the REDCap project.

![](./global.jpg)

Notice that each repeat of teh HAM-A is its own record.

![](./hama.jpg)

If a person has only done the baseline assessment they will only have record.
